services:
  tdlib-service:
    build:
      context: .
      dockerfile: tdlib-service/Dockerfile
    container_name: tdlib-service
    environment:
      TDLIB_SERVICE_PORT: 4002
      TDLIB_MODE: ${TDLIB_MODE:-mock}
      TDLIB_API_ID: ${TDLIB_API_ID:-}
      TDLIB_API_HASH: ${TDLIB_API_HASH:-}
      TDLIB_LIBRARY_PATH: ${TDLIB_DOCKER_LIBRARY_PATH:-/usr/local/lib/libtdjson.so}
      TDLIB_DATA_DIR: /app/tdlib-data
      TDLIB_REQUEST_TIMEOUT_MS: ${TDLIB_REQUEST_TIMEOUT_MS:-60000}
      TDLIB_RANGE_REQUEST_TIMEOUT_MS: ${TDLIB_RANGE_REQUEST_TIMEOUT_MS:-180000}
      TDLIB_MAX_GROUP_MEMBERS: ${TDLIB_MAX_GROUP_MEMBERS:-20}
    volumes:
      - ./tdlib-data:/app/tdlib-data
      - ./tdlib-service:/app/tdlib-service
    ports:
      - "4002:4002"

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: telegram-analyzer-api
    depends_on:
      - tdlib-service
    environment:
      API_PORT: 4001
      TDLIB_BASE_URL: http://tdlib-service:4002
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-5.2}
      OPENAI_STEP3_MODEL: ${OPENAI_STEP3_MODEL:-gpt-5.2}
      SESSION_TTL_MS: ${SESSION_TTL_MS:-604800000}
      RANGE_SCAN_MAX_BATCHES: ${RANGE_SCAN_MAX_BATCHES:-500}
      MONGODB_URI: ${MONGODB_URI:-}
      MONGODB_DB_NAME: ${MONGODB_DB_NAME:-telegram_chat_analyzer}
      MONGODB_PROMPTS_COLLECTION: ${MONGODB_PROMPTS_COLLECTION:-prompt_versions}
      TDLIB_REQUEST_TIMEOUT_MS: ${TDLIB_REQUEST_TIMEOUT_MS:-60000}
      TDLIB_RANGE_REQUEST_TIMEOUT_MS: ${TDLIB_RANGE_REQUEST_TIMEOUT_MS:-180000}
      TDLIB_MAX_GROUP_MEMBERS: ${TDLIB_MAX_GROUP_MEMBERS:-20}
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: "300"
    volumes:
      - ./api:/app/api
    ports:
      - "4001:4001"

  web:
    build:
      context: .
      dockerfile: web/Dockerfile
    container_name: telegram-analyzer-web
    depends_on:
      - api
    environment:
      VITE_API_BASE_URL: http://localhost:4001
      VITE_REQUEST_TIMEOUT_MS: ${VITE_REQUEST_TIMEOUT_MS:-60000}
      VITE_RANGE_REQUEST_TIMEOUT_MS: ${VITE_RANGE_REQUEST_TIMEOUT_MS:-300000}
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: "300"
    volumes:
      - ./web:/app/web
    ports:
      - "5173:5173"
