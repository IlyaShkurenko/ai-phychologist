import type { AnalysisMode, Locale } from "./types";

export const DEFAULT_LOCALE: Locale = "ru";
export const LOCALE_STORAGE_KEY = "telegram_analyzer_locale";

export const behaviorPatternIds = [
  "push_pull_dynamic",
  "boundary_testing",
  "passive_aggression",
  "defensiveness",
  "consistent_support",
] as const;

export const focusIds = ["manipulations", "aggression", "abuse", "ignore"] as const;
export const helpMeOptionIds = ["warn_spam", "suggest_pause", "suggest_confident_tone"] as const;
export const goalPresetIds = ["de_escalate_conflict", "detect_manipulation", "improve_reply_clarity"] as const;

type TranslationDict = Record<string, string>;

const messages: Record<Locale, TranslationDict> = {
  ru: {
    "app.title": "Telegram Chat Analyzer",
    "app.language": "Язык",
    "app.locale.ru": "Русский",
    "app.locale.en": "English",
    "app.disconnect": "Отключить Telegram",
    "app.clearSession": "Очистить данные сессии",
    "home.title": "Безопасный анализ диалогов в Telegram",
    "home.privacy": "Мы отправляем на анализ только выбранные вами сообщения.",
    "home.connect": "Подключить Telegram",
    "home.connecting": "Подключение...",
    "home.restoring": "Восстановление сессии...",
    "chatList.title": "Чаты",
    "chatList.search": "Поиск чатов",
    "chatList.noMessages": "Нет сообщений",
    "chatList.analyzeLast300": "Анализ последних 300",
    "chatList.loading": "Загрузка чатов...",
    "chatList.loadingMore": "Загружаем еще чаты...",
    "chatList.empty": "Чаты не найдены (показываем только приватные и группы до 20 участников).",
    "chatView.empty": "Выберите чат, чтобы просматривать сообщения.",
    "chatView.dateRange": "Диапазон дат",
    "chatView.analyzeLast300": "Анализ последних 300",
    "chatView.analyzeRange": "Анализ диапазона",
    "chatView.analyzeSelected": "Анализ выбранных ({count})",
    "chatView.scrollLoadOlder": "Прокрутите вверх, чтобы загрузить более старые сообщения.",
    "chatView.loadingMessages": "Загрузка сообщений...",
    "chatView.noMessages": "В этом чате не найдено сообщений.",
    "chatView.sender.me": "Я",
    "chatView.sender.other": "Другой",
    "chatView.replyTo": "Ответ на",
    "chatView.replyUnavailable": "Сообщение недоступно",
    "result.title": "Результат анализа",
    "result.empty": "Пока нет анализа.",
    "result.mode": "Режим",
    "result.messages": "Сообщения",
    "result.summary": "Сводка",
    "result.redFlags": "Красные флаги",
    "result.greenFlags": "Зелёные флаги",
    "result.patterns": "Паттерны",
    "result.suggestedReplies": "Варианты следующего ответа",
    "result.outcomes": "Исходы",
    "result.ifReply": "Если ответите",
    "result.ifNoReply": "Если не ответите",
    "mode.last300": "Последние 300",
    "mode.range": "Диапазон дат",
    "mode.selected": "Выбранные сообщения",
    "sheet.show": "Показать параметры анализа",
    "sheet.hide": "Скрыть параметры анализа",
    "sheet.close": "Закрыть",
    "sheet.reopen": "Открыть параметры анализа",
    "sheet.theme": "Тема",
    "sheet.theme.none": "Нет",
    "sheet.theme.love": "Любовь",
    "sheet.theme.work": "Работа",
    "sheet.theme.friendship": "Дружба",
    "sheet.theme.gaslighting": "Газлайтинг",
    "sheet.inputMode": "Режим входных данных",
    "sheet.behaviorPatterns": "Поведенческие паттерны",
    "sheet.focus": "Фокус",
    "sheet.addCustomFocus": "Добавить свой фокус",
    "sheet.add": "Добавить",
    "sheet.goalPreset": "Цель (пресет)",
    "sheet.goalPreset.custom": "Своя цель",
    "sheet.goalPreset.de_escalate_conflict": "Снизить напряжение в конфликте",
    "sheet.goalPreset.detect_manipulation": "Найти признаки манипуляции",
    "sheet.goalPreset.improve_reply_clarity": "Сделать ответ яснее",
    "sheet.goalText": "Текст цели",
    "sheet.goalPlaceholder": "Чего вы хотите от этого анализа?",
    "sheet.helpMe": "Помоги мне",
    "sheet.helpMeNote": "Дополнительная заметка для коучинга",
    "sheet.clearExceptGoal": "Очистить всё, кроме цели",
    "sheet.send": "Отправить на анализ",
    "sheet.sending": "Анализ...",
    "sheet.behavior.push_pull_dynamic": "Сближение и отдаление",
    "sheet.behavior.boundary_testing": "Проверка границ",
    "sheet.behavior.passive_aggression": "Пассивная агрессия",
    "sheet.behavior.defensiveness": "Защитная реакция",
    "sheet.behavior.consistent_support": "Стабильная поддержка",
    "sheet.focus.manipulations": "Манипуляции",
    "sheet.focus.aggression": "Агрессия",
    "sheet.focus.abuse": "Абьюз",
    "sheet.focus.ignore": "Игнор",
    "sheet.help.warn_spam": "Предупреди, если я спамлю",
    "sheet.help.suggest_pause": "Подскажи сделать паузу",
    "sheet.help.suggest_confident_tone": "Подскажи более уверенный тон",
    "login.title": "Подключение Telegram",
    "login.step.phone": "Шаг 1/3: Введите номер",
    "login.step.qrGenerate": "Шаг 1/3: Генерация QR",
    "login.step.qrScan": "Шаг 1/3: Сканируйте QR в Telegram",
    "login.step.code": "Шаг 2/3: Введите код",
    "login.step.password": "Шаг 3/3: Введите пароль 2FA",
    "login.step.connected": "Подключено",
    "login.step.auth": "Авторизация",
    "login.byPhone": "По номеру",
    "login.byQr": "По QR коду",
    "login.phone": "Номер телефона",
    "login.phonePlaceholder": "+1234567890",
    "login.openTelegramInstruction": "Откройте Telegram: Настройки → Устройства → Подключить устройство.",
    "login.generatingQr": "Генерация QR...",
    "login.qrAlt": "QR входа Telegram",
    "login.code": "Код",
    "login.codePlaceholder": "12345",
    "login.password": "Пароль 2FA",
    "login.continue": "Продолжить",
    "login.submitting": "Отправка...",
    "consent.title": "Согласие",
    "consent.body": "Мы отправим выбранные сообщения AI-провайдеру для анализа.",
    "consent.allowStorage": "Разрешить хранение выбранных сообщений (без контактов) для персонализации.",
    "consent.mvp": "MVP по умолчанию: отключено, постоянного хранения сообщений нет.",
    "consent.cancel": "Отмена",
    "consent.continue": "Продолжить",
    "dateRange.select": "Выберите диапазон дат",
    "dateRange.clear": "Очистить",
    "status.telegramConnected": "Telegram подключен",
    "status.telegramError": "Ошибка Telegram",
    "status.sessionRestored": "Сессия восстановлена",
    "status.failedRestoreSession": "Не удалось восстановить сессию автоматически. Попробуйте обновить страницу.",
    "status.sessionClosed": "Сессия закрыта",
    "status.failedLoadChats": "Не удалось загрузить чаты",
    "status.failedCreateSession": "Не удалось создать сессию",
    "status.failedDisconnect": "Не удалось отключить сессию",
    "status.failedClearSession": "Не удалось очистить сессию",
    "status.codeSent": "Код отправлен. Проверьте Telegram/SMS.",
    "status.phoneSubmitFailed": "Не удалось отправить номер",
    "status.codeSubmitted": "Код отправлен.",
    "status.codeSubmitFailed": "Не удалось отправить код",
    "status.passwordSubmitted": "Пароль отправлен.",
    "status.passwordSubmitFailed": "Не удалось отправить пароль",
    "status.scanQr": "Сканируйте QR в приложении Telegram.",
    "status.qrStartFailed": "Не удалось запустить QR-авторизацию",
    "status.failedLoadMessages": "Не удалось загрузить сообщения",
    "status.failedLoadOlderMessages": "Не удалось загрузить более старые сообщения",
    "status.selectMessage": "Выберите хотя бы одно сообщение.",
    "status.invalidRange": "Выберите корректный диапазон дат.",
    "status.analyzing": "Анализ выбранных сообщений...",
    "status.analysisComplete": "Анализ завершен.",
    "status.analysisCompleteWithPref":
      "Анализ завершен. Предпочтение хранения отмечено, но в MVP хранение сообщений отключено.",
    "status.analysisFailed": "Ошибка анализа",
    "status.selectChatFirst": "Сначала выберите чат.",
    "status.consentRequired": "Перед анализом нужно дать согласие.",
    "status.realtimeConnectionError": "Ошибка realtime-соединения",
    "status.realtimeParseError": "Не удалось разобрать realtime-событие",
  },
  en: {
    "app.title": "Telegram Chat Analyzer",
    "app.language": "Language",
    "app.locale.ru": "Russian",
    "app.locale.en": "English",
    "app.disconnect": "Disconnect Telegram",
    "app.clearSession": "Clear session data",
    "home.title": "Analyze Telegram dialogs safely",
    "home.privacy": "We send only messages you select for analysis.",
    "home.connect": "Connect Telegram",
    "home.connecting": "Connecting...",
    "home.restoring": "Restoring session...",
    "chatList.title": "Chats",
    "chatList.search": "Search chats",
    "chatList.noMessages": "No messages",
    "chatList.analyzeLast300": "Analyze last 300",
    "chatList.loading": "Loading chats...",
    "chatList.loadingMore": "Loading more chats...",
    "chatList.empty": "No chats found (showing only private chats and groups with under 20 members).",
    "chatView.empty": "Select a chat to browse messages.",
    "chatView.dateRange": "Date range",
    "chatView.analyzeLast300": "Analyze last 300",
    "chatView.analyzeRange": "Analyze range",
    "chatView.analyzeSelected": "Analyze selected ({count})",
    "chatView.scrollLoadOlder": "Scroll up to load older messages.",
    "chatView.loadingMessages": "Loading messages...",
    "chatView.noMessages": "No messages found for this chat.",
    "chatView.sender.me": "Me",
    "chatView.sender.other": "Other",
    "chatView.replyTo": "Reply to",
    "chatView.replyUnavailable": "Message unavailable",
    "result.title": "Analysis Result",
    "result.empty": "No analysis yet.",
    "result.mode": "Mode",
    "result.messages": "Messages",
    "result.summary": "Summary",
    "result.redFlags": "Red flags",
    "result.greenFlags": "Green flags",
    "result.patterns": "Patterns",
    "result.suggestedReplies": "Suggested next replies",
    "result.outcomes": "Outcomes",
    "result.ifReply": "If you reply",
    "result.ifNoReply": "If you don't reply",
    "mode.last300": "Last 300",
    "mode.range": "Date range",
    "mode.selected": "Selected messages",
    "sheet.show": "Show analysis options",
    "sheet.hide": "Hide analysis options",
    "sheet.close": "Close",
    "sheet.reopen": "Open analysis options",
    "sheet.theme": "Theme",
    "sheet.theme.none": "None",
    "sheet.theme.love": "Love",
    "sheet.theme.work": "Work",
    "sheet.theme.friendship": "Friendship",
    "sheet.theme.gaslighting": "Gaslighting",
    "sheet.inputMode": "Input mode",
    "sheet.behaviorPatterns": "Behavior patterns",
    "sheet.focus": "Focus",
    "sheet.addCustomFocus": "Add custom focus",
    "sheet.add": "Add",
    "sheet.goalPreset": "Goal preset",
    "sheet.goalPreset.custom": "Custom goal",
    "sheet.goalPreset.de_escalate_conflict": "De-escalate conflict",
    "sheet.goalPreset.detect_manipulation": "Detect manipulation",
    "sheet.goalPreset.improve_reply_clarity": "Improve reply clarity",
    "sheet.goalText": "Goal text",
    "sheet.goalPlaceholder": "What do you want from this analysis?",
    "sheet.helpMe": "Help me",
    "sheet.helpMeNote": "Optional coaching note",
    "sheet.clearExceptGoal": "Clear all except Goal",
    "sheet.send": "Send for analysis",
    "sheet.sending": "Analyzing...",
    "sheet.behavior.push_pull_dynamic": "Push-pull dynamic",
    "sheet.behavior.boundary_testing": "Boundary testing",
    "sheet.behavior.passive_aggression": "Passive aggression",
    "sheet.behavior.defensiveness": "Defensiveness",
    "sheet.behavior.consistent_support": "Consistent support",
    "sheet.focus.manipulations": "Manipulations",
    "sheet.focus.aggression": "Aggression",
    "sheet.focus.abuse": "Abuse",
    "sheet.focus.ignore": "Ignore",
    "sheet.help.warn_spam": "Warn me when I spam",
    "sheet.help.suggest_pause": "Suggest pause",
    "sheet.help.suggest_confident_tone": "Suggest more confident tone",
    "login.title": "Connect Telegram",
    "login.step.phone": "Step 1/3: Enter phone",
    "login.step.qrGenerate": "Step 1/3: Generate QR",
    "login.step.qrScan": "Step 1/3: Scan QR in Telegram app",
    "login.step.code": "Step 2/3: Enter code",
    "login.step.password": "Step 3/3: Enter 2FA password",
    "login.step.connected": "Connected",
    "login.step.auth": "Authentication",
    "login.byPhone": "By phone",
    "login.byQr": "By QR code",
    "login.phone": "Phone number",
    "login.phonePlaceholder": "+1234567890",
    "login.openTelegramInstruction": "Open Telegram app, then Settings, Devices, Link Desktop Device.",
    "login.generatingQr": "Generating QR...",
    "login.qrAlt": "Telegram login QR",
    "login.code": "Code",
    "login.codePlaceholder": "12345",
    "login.password": "2FA password",
    "login.continue": "Continue",
    "login.submitting": "Submitting...",
    "consent.title": "Consent",
    "consent.body": "We will send only selected messages to an AI provider for analysis.",
    "consent.allowStorage": "Allow storing selected messages (without contacts) for personalization.",
    "consent.mvp": "MVP default: disabled/no persistent message storage.",
    "consent.cancel": "Cancel",
    "consent.continue": "Continue",
    "dateRange.select": "Select date range",
    "dateRange.clear": "Clear",
    "status.telegramConnected": "Telegram connected",
    "status.telegramError": "Telegram error",
    "status.sessionRestored": "Session restored",
    "status.failedRestoreSession": "Failed to restore session automatically. Please refresh and try again.",
    "status.sessionClosed": "Session closed",
    "status.failedLoadChats": "Failed to load chats",
    "status.failedCreateSession": "Failed to create session",
    "status.failedDisconnect": "Failed to disconnect",
    "status.failedClearSession": "Failed to clear session",
    "status.codeSent": "Code sent. Check Telegram/SMS.",
    "status.phoneSubmitFailed": "Phone submission failed",
    "status.codeSubmitted": "Code submitted.",
    "status.codeSubmitFailed": "Code submission failed",
    "status.passwordSubmitted": "Password submitted.",
    "status.passwordSubmitFailed": "Password submission failed",
    "status.scanQr": "Scan QR in Telegram app.",
    "status.qrStartFailed": "QR auth start failed",
    "status.failedLoadMessages": "Failed to load messages",
    "status.failedLoadOlderMessages": "Failed to load older messages",
    "status.selectMessage": "Select at least one message.",
    "status.invalidRange": "Set valid date range for range mode.",
    "status.analyzing": "Analyzing selected messages...",
    "status.analysisComplete": "Analysis complete.",
    "status.analysisCompleteWithPref":
      "Analysis complete. Optional storage preference is captured but message storage remains disabled in MVP.",
    "status.analysisFailed": "Analysis failed",
    "status.selectChatFirst": "Select a chat first.",
    "status.consentRequired": "Consent is required before analysis.",
    "status.realtimeConnectionError": "Realtime connection error",
    "status.realtimeParseError": "Failed to parse realtime event",
  },
};

export function isLocale(value: string | null | undefined): value is Locale {
  return value === "ru" || value === "en";
}

export function localeCode(locale: Locale): string {
  return locale === "ru" ? "ru-RU" : "en-US";
}

export function t(locale: Locale, key: string, params?: Record<string, string | number>): string {
  const template = messages[locale][key] ?? messages.en[key] ?? key;
  if (!params) {
    return template;
  }
  return template.replace(/\{(\w+)\}/g, (match, token: string) => {
    if (!(token in params)) {
      return match;
    }
    return String(params[token]);
  });
}

export function behaviorPatternLabel(locale: Locale, value: string): string {
  const key = `sheet.behavior.${value}`;
  const fallback = messages.en[key];
  return fallback ? t(locale, key) : value;
}

export function focusLabel(locale: Locale, value: string): string {
  const key = `sheet.focus.${value}`;
  const fallback = messages.en[key];
  return fallback ? t(locale, key) : value;
}

export function helpMeLabel(locale: Locale, value: string): string {
  const key = `sheet.help.${value}`;
  const fallback = messages.en[key];
  return fallback ? t(locale, key) : value;
}

export function goalPresetText(locale: Locale, value: (typeof goalPresetIds)[number]): string {
  return t(locale, `sheet.goalPreset.${value}`);
}

export function modeLabel(locale: Locale, mode: AnalysisMode): string {
  return t(locale, `mode.${mode}`);
}
